<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jobsim 管理画面</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .table-container { max-height: calc(100vh - 300px); overflow-y: auto; }
        td, th { padding: 8px; border: 1px solid #ddd; min-width: 150px; vertical-align: top; }
        textarea { width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; min-height: 60px; }
        #admin-panel-container { display: flex; height: 100vh; }
        #editor-pane { width: 50%; padding: 1rem; overflow-y: auto; }
        #preview-pane { width: 50%; border-left: 2px solid #e5e7eb; display: flex; flex-direction: column; }
        #preview-iframe { flex-grow: 1; border: none; }
    </style>
</head>
<body class="bg-gray-100 overflow-hidden">

    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="loader"></div></div>

    <div id="login-screen" class="max-w-md mx-auto mt-20 p-8 bg-white rounded-lg shadow-md">
        <h1 class="text-2xl font-bold text-center mb-6">管理画面ログイン</h1>
        <input type="text" id="username" placeholder="ユーザー名" class="w-full px-4 py-2 border rounded-lg mb-4">
        <input type="password" id="password" placeholder="パスワード" class="w-full px-4 py-2 border rounded-lg mb-4">
        <button id="login-button" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">ログイン</button>
        <p id="login-error" class="text-red-500 text-sm mt-2"></p>
    </div>

    <div id="admin-panel" class="hidden">
        <div id="admin-panel-container">
            <!-- 左側：エディタ -->
            <div id="editor-pane">
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                    <h1 class="text-3xl font-bold">データ編集</h1>
                    <div class="flex items-center gap-4">
                        <button id="toggle-credential-form" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 text-sm">認証情報変更</button>
                        <button id="logout-button" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">ログアウト</button>
                    </div>
                </div>
                <div id="credential-form" class="hidden bg-white p-6 rounded-lg shadow-md mb-6"><!-- 認証情報フォーム --></div>
                <div id="sheet-tabs" class="mb-4 border-b"></div>
                <div class="table-container bg-white rounded-lg shadow">
                    <table id="data-table" class="w-full text-sm text-left text-gray-500">
                        <thead id="table-head"></thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
                <div id="action-buttons" class="mt-6 flex gap-4">
                    <button id="save-button" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">変更を保存</button>
                    <button id="preview-update-button" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700">プレビュー更新</button>
                    <button id="add-row-button" class="hidden bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">レコードを追加</button>
                </div>
            </div>

            <!-- 右側：プレビュー -->
            <div id="preview-pane">
                <div class="p-4 bg-gray-200">
                    <label for="preview-url-input" class="block text-sm font-medium text-gray-700">プレビュー用URL</label>
                    <div class="mt-1 flex gap-2">
                        <input type="text" id="preview-url-input" class="flex-grow shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md" placeholder="シミュレーションHTMLのURL">
                        <button id="load-preview-button" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">読込</button>
                    </div>
                    <!-- ★★★★★ ヒントを追加 ★★★★★ -->
                    <p class="mt-2 text-xs text-gray-600">
                        <strong>ヒント:</strong> プレビューが表示されない場合、シミュレーション用HTMLファイルをウェブ上にアップロードする必要があります。<a href="https://app.netlify.com/drop" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline">Netlify Drop</a>などのサービスでファイルからURLを簡単に作成できます。
                    </p>
                </div>
                <!-- ★★★★★ sandbox属性を追加 ★★★★★ -->
                <iframe id="preview-iframe" title="Job Simulation Preview" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
            </div>
        </div>
    </div>

<script>
// ★★★★★ URLを更新しました ★★★★★
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxgj4EEtzSq8WcRlBG9uMUzDYN-GI2HtQ8J2yC9b9VZmpMhYLeb1g9kdCbJKDL0mQRY5g/exec';

// --- DOM Elements ---
const loginScreen = document.getElementById('login-screen');
const adminPanel = document.getElementById('admin-panel');
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const loginButton = document.getElementById('login-button');
const logoutButton = document.getElementById('logout-button');
const loginError = document.getElementById('login-error');
const sheetTabs = document.getElementById('sheet-tabs');
const tableHead = document.getElementById('table-head');
const tableBody = document.getElementById('table-body');
const saveButton = document.getElementById('save-button');
const addRowButton = document.getElementById('add-row-button');
const loadingOverlay = document.getElementById('loading-overlay');
const credentialFormContainer = document.getElementById('credential-form');
const toggleCredentialButton = document.getElementById('toggle-credential-form');
const previewUrlInput = document.getElementById('preview-url-input');
const loadPreviewButton = document.getElementById('load-preview-button');
const previewIframe = document.getElementById('preview-iframe');
const previewUpdateButton = document.getElementById('preview-update-button');

let currentSheet = '';
let allSheetData = {}; // 全シートのデータを保持する
const sheetNames = ['設定', 'コンテンツデータ', 'スコア定義', '判定ロジック', 'ヒント', '話者設定'];

// --- Event Listeners ---
loginButton.addEventListener('click', handleLogin);
logoutButton.addEventListener('click', handleLogout);
saveButton.addEventListener('click', handleSave);
addRowButton.addEventListener('click', handleAddRow);
toggleCredentialButton.addEventListener('click', toggleCredentialForm);
loadPreviewButton.addEventListener('click', () => {
    const url = previewUrlInput.value;
    if (url) {
        previewIframe.src = url;
    } else {
        alert('プレビュー用のURLを入力してください。');
    }
});
previewUpdateButton.addEventListener('click', handlePreviewUpdate);

// --- Credential Form ---
function toggleCredentialForm() {
    const isHidden = credentialFormContainer.classList.contains('hidden');
    if (isHidden) {
        credentialFormContainer.classList.remove('hidden');
        credentialFormContainer.innerHTML = `
            <h2 class="text-xl font-bold mb-4">認証情報の変更</h2>
            <div class="space-y-4">
                <input type="password" id="current-password" placeholder="現在のパスワード" class="w-full px-4 py-2 border rounded">
                <input type="text" id="new-username" placeholder="新しいユーザー名" class="w-full px-4 py-2 border rounded">
                <input type="password" id="new-password" placeholder="新しいパスワード" class="w-full px-4 py-2 border rounded">
                <input type="password" id="confirm-password" placeholder="新しいパスワード（確認）" class="w-full px-4 py-2 border rounded">
            </div>
            <button id="change-credentials-button" class="mt-4 bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">変更を保存</button>
            <p id="credential-message" class="text-sm mt-2"></p>
        `;
        document.getElementById('change-credentials-button').addEventListener('click', handleChangeCredentials);
    } else {
        credentialFormContainer.classList.add('hidden');
        credentialFormContainer.innerHTML = '';
    }
}

// --- Authentication ---
function handleLogin() {
    const username = usernameInput.value;
    const password = passwordInput.value;
    if (!username || !password) {
        loginError.textContent = 'ユーザー名とパスワードを入力してください。';
        return;
    }
    loginError.textContent = '';
    
    callGas('login', { username, password })
        .then(result => {
            if (result.success) {
                sessionStorage.setItem('jobsim_admin_token', result.token);
                loginScreen.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                initializeAdminPanel();
            } else {
                loginError.textContent = result.message || 'ログインに失敗しました。';
            }
        });
}

function handleLogout() {
    sessionStorage.removeItem('jobsim_admin_token');
    adminPanel.classList.add('hidden');
    loginScreen.classList.remove('hidden');
    passwordInput.value = '';
    usernameInput.value = '';
}

function checkLogin() {
    if (sessionStorage.getItem('jobsim_admin_token')) {
        loginScreen.classList.add('hidden');
        adminPanel.classList.remove('hidden');
        initializeAdminPanel();
    }
}

function handleChangeCredentials() {
    const currentPassword = document.getElementById('current-password').value;
    const newUsername = document.getElementById('new-username').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    const credentialMessage = document.getElementById('credential-message');

    credentialMessage.textContent = '';
    if (!currentPassword || !newUsername || !newPassword) {
        credentialMessage.textContent = 'すべての必須項目を入力してください。';
        credentialMessage.className = 'text-red-500 text-sm mt-2';
        return;
    }
    if (newPassword !== confirmPassword) {
        credentialMessage.textContent = '新しいパスワードが一致しません。';
        credentialMessage.className = 'text-red-500 text-sm mt-2';
        return;
    }

    callGas('changeCredentials', { currentPassword, newUsername, newPassword })
        .then(result => {
            if (result.success) {
                credentialMessage.textContent = '認証情報を更新しました。';
                credentialMessage.className = 'text-green-600 text-sm mt-2';
                ['current-password', 'new-username', 'new-password', 'confirm-password'].forEach(id => document.getElementById(id).value = '');
            } else {
                credentialMessage.textContent = result.message || '更新に失敗しました。';
                credentialMessage.className = 'text-red-500 text-sm mt-2';
            }
        });
}

// --- Admin Panel Initialization ---
async function initializeAdminPanel() {
    sheetTabs.innerHTML = '';
    sheetNames.forEach(name => {
        const tab = document.createElement('button');
        tab.textContent = name;
        tab.dataset.sheetName = name;
        tab.className = 'px-4 py-2 -mb-px font-semibold text-gray-800 border-b-2 border-transparent hover:border-blue-500';
        tab.onclick = () => switchSheet(name);
        sheetTabs.appendChild(tab);
    });

    allSheetData = await callGas('getAllSheetData', {});
    if (!allSheetData || Object.keys(allSheetData).length === 0) {
        alert('シートデータの読み込みに失敗しました。');
        return;
    }

    await switchSheet(sheetNames[0]);
    
    const savedUrl = localStorage.getItem('jobsim_preview_url');
    if (savedUrl) {
        previewUrlInput.value = savedUrl;
        previewIframe.src = savedUrl;
    }
}

async function switchSheet(sheetName) {
    currentSheet = sheetName;
    document.querySelectorAll('#sheet-tabs button').forEach(tab => {
        tab.classList.toggle('border-blue-500', tab.dataset.sheetName === sheetName);
        tab.classList.toggle('text-blue-600', tab.dataset.sheetName === sheetName);
    });
    addRowButton.classList.toggle('hidden', sheetName !== 'コンテンツデータ');
    
    renderTable(allSheetData[sheetName] || []);
}

// --- Table Rendering and Data Handling ---
function renderTable(data) {
    if (!data || data.length === 0) {
        tableHead.innerHTML = '<tr><th class="px-4 py-2">データがありません</th></tr>';
        tableBody.innerHTML = '';
        return;
    }
    
    const headers = Object.keys(data[0]);
    tableHead.innerHTML = `<tr>${headers.map(h => `<th class="px-4 py-2">${h}</th>`).join('')}<th>削除</th></tr>`;
    
    tableBody.innerHTML = '';
    data.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        tr.className = "bg-white border-b";
        headers.forEach(header => {
            const td = document.createElement('td');
            const textarea = document.createElement('textarea');
            textarea.value = row[header];
            textarea.dataset.rowIndex = rowIndex;
            textarea.dataset.header = header;
            if (header === 'phaseDescription') {
                textarea.style.minWidth = '300px';
            }
            td.appendChild(textarea);
            tr.appendChild(td);
        });
        
        const deleteTd = document.createElement('td');
        if (currentSheet === 'コンテンツデータ' && row['dataType'] === 'phase') {
            const deleteButton = document.createElement('button');
            deleteButton.textContent = '削除';
            deleteButton.className = 'bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600';
            deleteButton.onclick = () => handleDeleteRow(rowIndex);
            deleteTd.appendChild(deleteButton);
        }
        tr.appendChild(deleteTd);
        tableBody.appendChild(tr);
    });
}

function updateLocalDataFromTable() {
    const updatedData = [];
    const rows = tableBody.rows;
    if (rows.length === 0) {
        allSheetData[currentSheet] = [];
        return;
    }
    const headers = Array.from(tableHead.querySelectorAll('th')).slice(0, -1).map(th => th.textContent);

    for (let i = 0; i < rows.length; i++) {
        const rowObject = {};
        const cells = rows[i].cells;
        for (let j = 0; j < headers.length; j++) {
            const textarea = cells[j].querySelector('textarea');
            if (textarea) {
                rowObject[headers[j]] = textarea.value;
            }
        }
        updatedData.push(rowObject);
    }
    allSheetData[currentSheet] = updatedData;
}

function handleSave() {
    updateLocalDataFromTable();
    const dataToSave = allSheetData[currentSheet];

    if (confirm('この変更をスプレッドシートに保存しますか？')) {
        callGas('updateSheet', { sheetName: currentSheet, data: dataToSave })
            .then(result => {
                if(result.success) {
                    alert('保存しました。');
                } else {
                    alert('保存に失敗しました。\n' + result.message);
                }
            });
    }
}

function handleAddRow() {
    if (currentSheet !== 'コンテンツデータ') return;
    updateLocalDataFromTable();

    const headers = (allSheetData[currentSheet] && allSheetData[currentSheet].length > 0) 
        ? Object.keys(allSheetData[currentSheet][0]) 
        : (allSheetData['設定'] && allSheetData['設定'].length > 0 ? Object.keys(allSheetData['設定'][0]) : []);

    if (!headers || headers.length === 0) {
        alert('シートにヘッダーがありません。先にスプレッドシート側でヘッダーを設定してください。');
        return;
    }
    
    const newRecord = headers.reduce((acc, key) => ({...acc, [key]: ''}), {});
    newRecord[headers[0]] = ' '; // Make sure it's not an empty row

    allSheetData[currentSheet].push(newRecord);
    renderTable(allSheetData[currentSheet]);
}

function handleDeleteRow(rowIndex) {
     if (currentSheet !== 'コンテンツデータ') return;
     if (confirm(`${rowIndex + 1}行目のレコードを削除しますか？`)) {
        updateLocalDataFromTable();
        allSheetData[currentSheet].splice(rowIndex, 1);
        renderTable(allSheetData[currentSheet]);
        alert('ローカルデータを削除しました。「変更を保存」ボタンを押して確定してください。');
    }
}

// --- Preview ---
async function handlePreviewUpdate() {
    const iframe = previewIframe;
    if (!iframe.src || iframe.src === 'about:blank') {
        alert('先にプレビュー用URLを読み込んでください。');
        return;
    }
    
    updateLocalDataFromTable();

    const gameData = {
        settings: allSheetData['設定'] ? allSheetData['設定'][0] : {},
        contents: allSheetData['コンテンツデータ'] || [],
        scoreDefinitions: (allSheetData['スコア定義'] || []).reduce((obj, item) => (obj[item.key] = item.name, obj), {}),
        logics: allSheetData['判定ロジック'] || [],
        hints: (allSheetData['ヒント'] || []).reduce((obj, item) => (obj[item.phaseId] = item.hintText, obj), {}),
        speakers: (allSheetData['話者設定'] || []).reduce((obj, item) => (obj[item.speakerName] = item.iconUrl, obj), {})
    };

    iframe.contentWindow.postMessage({ type: 'JOB_SIM_PREVIEW_DATA', payload: gameData }, '*');
    
    localStorage.setItem('jobsim_preview_url', previewUrlInput.value);
}


// --- GAS Communication ---
async function callGas(action, payload = {}) {
    loadingOverlay.classList.remove('hidden');
    try {
        const token = sessionStorage.getItem('jobsim_admin_token');
        const res = await fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({ action, token, ...payload }),
            // headersとredirectを削除することで、CORS preflightを回避
        });
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return await res.json();
    } catch (e) {
        console.error('GAS call failed:', e);
        loginError.textContent = '通信エラーが発生しました。GASのURLが正しいか、再デプロイされているか確認してください。';
        alert('エラーが発生しました。コンソールを確認してください。');
        return { success: false, message: e.message };
    } finally {
        loadingOverlay.classList.add('hidden');
    }
}

// --- Initial execution ---
checkLogin();
</script>
</body>
</html>

