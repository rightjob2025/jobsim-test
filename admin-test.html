<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jobsim 管理画面</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .table-container { max-height: calc(100vh - 300px); overflow-y: auto; }
        td, th { padding: 8px; border: 1px solid #ddd; min-width: 150px; vertical-align: top; }
        textarea, input[type="text"], input[type="password"] { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        #admin-panel-container { display: flex; height: 100vh; }
        #editor-pane { padding: 1rem; overflow-y: auto; }
        #resizer { width: 10px; cursor: col-resize; background-color: #e5e7eb; position: relative; transition: background-color 0.2s; }
        #resizer:hover { background-color: #9ca3af; }
        #preview-pane { display: flex; flex-direction: column; }
        #preview-iframe { flex-grow: 1; border: none; }
    </style>
</head>
<body class="bg-gray-100 overflow-hidden">

    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="loader"></div></div>

    <!-- ログイン画面 -->
    <div id="login-screen" class="max-w-md mx-auto mt-10 p-8 bg-white rounded-lg shadow-md">
        <h1 class="text-2xl font-bold text-center mb-6">管理画面ログイン</h1>
        
        <div class="mb-4">
            <label for="spreadsheet-id" class="block text-sm font-medium text-gray-700">ジョブシムID</label>
            <input type="text" id="spreadsheet-id" placeholder="操作したいジョブシムのID" class="w-full px-4 py-2 border rounded-lg mt-1">
        </div>
        <div class="mb-4">
            <label for="username" class="block text-sm font-medium text-gray-700">ユーザー名</label>
            <input type="text" id="username" placeholder="ユーザー名" class="w-full px-4 py-2 border rounded-lg mt-1">
        </div>
        <div class="mb-4">
             <label for="password" class="block text-sm font-medium text-gray-700">パスワード</label>
            <input type="password" id="password" placeholder="パスワード" class="w-full px-4 py-2 border rounded-lg mt-1">
        </div>
        <button id="login-button" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">ログイン</button>
        <p id="login-error" class="text-red-500 text-sm mt-2"></p>
    </div>

    <!-- 管理画面 -->
    <div id="admin-panel" class="hidden">
        <div id="admin-panel-container">
            <div id="editor-pane" style="width: 50%;">
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4"> <h1 class="text-3xl font-bold">データ編集</h1> <div class="flex items-center gap-4"> <button id="toggle-credential-form" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 text-sm hidden">認証情報変更</button> <button id="logout-button" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">ログアウト</button> </div> </div> <div id="credential-form" class="hidden bg-white p-6 rounded-lg shadow-md mb-6"> <h2 class="text-xl font-bold mb-4">認証情報の変更</h2> <div class="space-y-4"> <input type="password" id="current-password" placeholder="現在のパスワード"> <input type="text" id="new-username" placeholder="新しいユーザー名"> <input type="password" id="new-password" placeholder="新しいパスワード"> <input type="password" id="confirm-password" placeholder="新しいパスワード（確認）"> </div> <button id="change-credentials-button" class="mt-4 bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">変更を保存</button> <p id="credential-message" class="text-sm mt-2"></p> </div> <div id="sheet-tabs" class="mb-4 border-b"></div> <div class="table-container bg-white rounded-lg shadow"> <table id="data-table" class="w-full text-sm text-left text-gray-500"> <thead id="table-head"></thead> <tbody id="table-body"></tbody> </table> </div> <div id="action-buttons" class="mt-6 flex gap-4"> <button id="save-button" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">変更を保存</button> <button id="preview-update-button" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700">プレビュー更新</button> <button id="add-row-button" class="hidden bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">レコードを追加</button> </div>
            </div>
            
            <div id="resizer"></div>
            
            <div id="preview-pane" class="flex-grow">
                <div class="p-4 bg-gray-200 border-b">
                    <h2 class="text-lg font-bold text-gray-700">プレビュー</h2>
                </div>
                <iframe id="preview-iframe" title="Job Simulation Preview"></iframe>
            </div>
        </div>
    </div>

<script>
// ★★★★★【重要：要設定】★★★★★
const GAS_URL = 'https://script.google.com/macros/s/AKfycby5J6CR-pgF8imIIlmGagEnSaXLzrzmWpubR9gg_VcwILRvvnUhtJ0BVCTXhk5anvsL/exec';
const PREVIEW_URL = 'https://rightjob2025.github.io/jobsim-test';

// DOM Elements
const loginScreen = document.getElementById('login-screen');
const adminPanel = document.getElementById('admin-panel');
const spreadsheetIdInput = document.getElementById('spreadsheet-id');
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const loginButton = document.getElementById('login-button');
const loginError = document.getElementById('login-error');
const previewIframe = document.getElementById('preview-iframe');
const previewUpdateButton = document.getElementById('preview-update-button');
const credentialForm = document.getElementById('credential-form');
const toggleCredentialButton = document.getElementById('toggle-credential-form');
const changeCredentialsButton = document.getElementById('change-credentials-button');
const credentialMessage = document.getElementById('credential-message');
const logoutButton = document.getElementById('logout-button');
const sheetTabs = document.getElementById('sheet-tabs');
const tableHead = document.getElementById('table-head');
const tableBody = document.getElementById('table-body');
const saveButton = document.getElementById('save-button');
const addRowButton = document.getElementById('add-row-button');
const editorPane = document.getElementById('editor-pane');
const resizer = document.getElementById('resizer');

let allSheetData = {};
let currentSheet = '';
const sheetNames = ['設定', 'コンテンツデータ', 'スコア定義', '判定ロジック', 'ヒント', '話者設定'];


// --- Initialization & Event Listeners ---
document.addEventListener('DOMContentLoaded', () => {
    loginButton.addEventListener('click', handleLogin);
    previewUpdateButton.addEventListener('click', handlePreviewUpdate);
    logoutButton.addEventListener('click', handleLogout);
    toggleCredentialButton.addEventListener('click', () => credentialForm.classList.toggle('hidden'));
    changeCredentialsButton.addEventListener('click', handleChangeCredentials);
    saveButton.addEventListener('click', handleSave);
    addRowButton.addEventListener('click', handleAddRow);

    let isResizing = false;
    resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        previewIframe.style.pointerEvents = 'none';
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', stopResizing);
    });
    
    function stopResizing() {
        if (isResizing) {
            isResizing = false;
            previewIframe.style.pointerEvents = 'auto';
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', stopResizing);
        }
    }

    function handleMouseMove(e) {
        if (!isResizing) return;
        const totalWidth = document.getElementById('admin-panel-container').offsetWidth;
        let newEditorWidth = e.clientX;
        if (newEditorWidth < 300) newEditorWidth = 300;
        if (totalWidth - newEditorWidth - resizer.offsetWidth < 300) {
            newEditorWidth = totalWidth - resizer.offsetWidth - 300;
        }
        editorPane.style.width = `${newEditorWidth}px`;
    }

    spreadsheetIdInput.value = localStorage.getItem('jobsim_spreadsheet_id') || '';
    checkLogin();
});


// --- Authentication ---
function handleLogin() {
    const spreadsheetId = spreadsheetIdInput.value.trim();
    const username = usernameInput.value;
    const password = passwordInput.value;

    if (!spreadsheetId) {
        loginError.textContent = 'スプレッドシートIDを入力してください。';
        return;
    }
    if (!username || !password) {
        loginError.textContent = 'ユーザー名とパスワードを入力してください。';
        return;
    }
    loginError.textContent = '';

    localStorage.setItem('jobsim_spreadsheet_id', spreadsheetId);

    callGas('login', { username, password })
        .then(result => {
            if (result.success) {
                sessionStorage.setItem('jobsim_admin_token', result.token);
                loginScreen.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                initializeAdminPanel();
            } else {
                loginError.textContent = result.message || 'ログインに失敗しました。';
            }
        });
}

function checkLogin() {
    if (sessionStorage.getItem('jobsim_admin_token')) {
        loginScreen.classList.add('hidden');
        adminPanel.classList.remove('hidden');
        initializeAdminPanel();
    }
}

function handleLogout() {
    sessionStorage.removeItem('jobsim_admin_token');
    adminPanel.classList.add('hidden');
    loginScreen.classList.remove('hidden');
    passwordInput.value = '';
    usernameInput.value = '';
}

function handleChangeCredentials() {
    const currentPassword = document.getElementById('current-password').value;
    const newUsername = document.getElementById('new-username').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    credentialMessage.textContent = '';
    if (!currentPassword || !newUsername || !newPassword) {
        credentialMessage.textContent = 'すべての必須項目を入力してください。';
        credentialMessage.className = 'text-red-500 text-sm mt-2';
        return;
    }
    if (newPassword !== confirmPassword) {
        credentialMessage.textContent = '新しいパスワードが一致しません。';
        credentialMessage.className = 'text-red-500 text-sm mt-2';
        return;
    }
    callGas('changeCredentials', { currentPassword, newUsername, newPassword })
        .then(result => {
            if (result.success) {
                credentialMessage.textContent = '認証情報を更新しました。';
                credentialMessage.className = 'text-green-600 text-sm mt-2';
                ['current-password', 'new-username', 'new-password', 'confirm-password'].forEach(id => document.getElementById(id).value = '');
            } else {
                credentialMessage.textContent = result.message || '更新に失敗しました。';
                credentialMessage.className = 'text-red-500 text-sm mt-2';
            }
        });
}

// --- Main Admin Panel Functions ---
async function initializeAdminPanel() {
    sheetTabs.innerHTML = '';
    sheetNames.forEach(name => {
        const tab = document.createElement('button');
        tab.textContent = name;
        tab.dataset.sheetName = name;
        tab.className = 'px-4 py-2 -mb-px font-semibold text-gray-800 border-b-2 border-transparent hover:border-blue-500';
        tab.onclick = () => switchSheet(name);
        sheetTabs.appendChild(tab);
    });
    
    allSheetData = await callGas('getAllSheetData', {});
    if (!allSheetData || Object.keys(allSheetData).length === 0) {
        alert('シートデータの読み込みに失敗しました。');
        return;
    }
    
    await switchSheet(sheetNames[0]);
    
    previewIframe.src = PREVIEW_URL;
}

async function switchSheet(sheetName) {
    currentSheet = sheetName;
    document.querySelectorAll('#sheet-tabs button').forEach(tab => {
        tab.classList.toggle('border-blue-500', tab.dataset.sheetName === sheetName);
        tab.classList.toggle('text-blue-600', tab.dataset.sheetName === sheetName);
    });
    addRowButton.classList.toggle('hidden', sheetName !== 'コンテンツデータ');
    const data = allSheetData[currentSheet];
    renderTable(data);
}

function renderTable(dataObject) {
    const headers = dataObject.headers || [];
    const rows = dataObject.rows || [];

    if (headers.length === 0) {
        tableHead.innerHTML = '<tr><th>シートが見つからないか、ヘッダーがありません</th></tr>';
        tableBody.innerHTML = '';
        return;
    }

    tableHead.innerHTML = `<tr>${headers.map(h => `<th class="px-4 py-2">${h}</th>`).join('')}<th>削除</th></tr>`;

    if (rows.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="' + (headers.length + 1) + '" class="text-center p-4">データがありません。</td></tr>';
        return;
    }

    tableBody.innerHTML = '';
    rows.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        tr.className = "bg-white border-b";
        headers.forEach(header => {
            const td = document.createElement('td');
            td.style.minWidth = header === 'phaseDescription' ? '400px' : '200px';
            const textarea = document.createElement('textarea');
            textarea.value = row[header] || '';
            textarea.dataset.rowIndex = rowIndex;
            textarea.dataset.header = header;
            td.appendChild(textarea);
            tr.appendChild(td);
        });
        const deleteTd = document.createElement('td');
        if (currentSheet === 'コンテンツデータ' && row['dataType'] === 'phase') {
            const deleteButton = document.createElement('button');
            deleteButton.textContent = '削除';
            deleteButton.className = 'bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600';
            deleteButton.onclick = () => handleDeleteRow(rowIndex);
            deleteTd.appendChild(deleteButton);
        }
        tr.appendChild(deleteTd);
        tableBody.appendChild(tr);
    });
}

function handleSave() {
    updateLocalDataFromTable();
    const dataToSave = allSheetData[currentSheet].rows;
    if (confirm('この変更を保存しますか？')) {
        callGas('updateSheet', { sheetName: currentSheet, data: dataToSave })
            .then(result => {
                if (result.success) {
                    alert('保存しました。');
                } else {
                    alert('保存に失敗しました。\n' + result.message);
                }
            });
    }
}

// ★★★★★【修正済み】★★★★★
function handleAddRow() {
    if (currentSheet !== 'コンテンツデータ') return;
    const headers = allSheetData[currentSheet].headers;

    if (!headers || headers.length === 0) {
        alert('シートの列情報を取得できません。先にスプレッドシート側でヘッダー（1行目）を入力してください。');
        return;
    }

    const newRecord = headers.reduce((acc, header) => {
        acc[header] = '';
        return acc;
    }, {});
    
    // ご要望に基づき、dataType列に'***'を設定して空行を防ぐ
    if (headers.includes('dataType')) {
        newRecord['dataType'] = '***';
    } else {
        // dataType列がない場合のフォールバックとして、最初の列に印をつける
        newRecord[headers[0]] = ' '; 
    }

    if (confirm('新しい空のレコードを末尾に追加しますか？')) {
        callGas('addRow', { sheetName: 'コンテンツデータ', record: newRecord })
            .then(result => {
                if (result.success) {
                    alert('レコードを追加しました。画面を更新します。');
                    initializeAdminPanel(); 
                } else {
                    alert('追加に失敗しました。\n' + result.message);
                }
            });
    }
}

function handleDeleteRow(rowIndex) {
    if (currentSheet !== 'コンテンツデータ') return;
    const rowNumber = rowIndex + 2; 
    if (confirm(`${rowIndex + 1}行目のレコードを削除しますか？この操作は元に戻せません。`)) {
        callGas('deleteRow', { sheetName: 'コンテンツデータ', rowNumber: rowNumber })
            .then(result => {
                if (result.success) {
                    alert('削除しました。');
                    initializeAdminPanel();
                } else {
                    alert('削除に失敗しました。\n' + result.message);
                }
            });
    }
}

async function handlePreviewUpdate() {
    const iframe = previewIframe;
    if (!iframe.src) {
        alert('プレビューが読み込まれていません。');
        return;
    }
    updateLocalDataFromTable();
    const gameData = {
        settings: allSheetData['設定'].rows.length > 0 ? allSheetData['設定'].rows[0] : {},
        contents: allSheetData['コンテンツデータ'].rows || [],
        scoreDefinitions: (allSheetData['スコア定義'].rows || []).reduce((obj, item) => {
            if (item.key) obj[item.key] = item.name;
            return obj;
        }, {}),
        logics: allSheetData['判定ロジック'].rows || [],
        hints: (allSheetData['ヒント'].rows || []).reduce((obj, item) => {
            if (item.phaseId) obj[item.phaseId] = item.hintText;
            return obj;
        }, {}),
        speakers: (allSheetData['話者設定'].rows || []).reduce((obj, item) => {
            if (item.speakerName) obj[item.speakerName] = item.iconUrl;
            return obj;
        }, {}),
    };
    iframe.contentWindow.postMessage({ type: 'JOB_SIM_PREVIEW_DATA', payload: gameData }, '*');
}

function updateLocalDataFromTable() {
    const rows = tableBody.rows;
    if (rows.length === 0 || (rows.length === 1 && rows[0].cells.length <= 1)) {
        allSheetData[currentSheet].rows = [];
        return;
    }
    const headers = allSheetData[currentSheet].headers;
    const updatedData = Array.from(rows).map(row => {
        const rowObject = {};
        headers.forEach((header, i) => {
            const cell = row.cells[i];
            const textarea = cell ? cell.querySelector('textarea') : null;
            if (textarea) {
                rowObject[header] = textarea.value;
            }
        });
        return rowObject;
    });
    allSheetData[currentSheet].rows = updatedData;
}


// --- GAS Communication ---
async function callGas(action, payload = {}) {
    document.getElementById('loading-overlay').classList.remove('hidden');

    const spreadsheetId = localStorage.getItem('jobsim_spreadsheet_id');
    if (!GAS_URL || GAS_URL === 'YOUR_GAS_URL_HERE') {
        loginError.textContent = 'URLが設定されていません。HTMLファイルを編集してください。';
        document.getElementById('loading-overlay').classList.add('hidden');
        return { success: false, message: 'GAS URL not configured' };
    }

    try {
        const token = sessionStorage.getItem('jobsim_admin_token');
        const res = await fetch(GAS_URL, {
            method: 'POST',
            mode: 'cors',
            credentials: 'omit',
            body: JSON.stringify({ action, token, spreadsheetId, ...payload }),
            redirect: 'follow'
        });

        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        return await res.json();
    } catch (e) {
        console.error('GAS call failed:', e);
        loginError.textContent = '通信に失敗しました。URLが正しいか、CORS設定がされているか確認してください。';
        alert('エラーが発生しました。コンソールを確認してください。');
        return { success: false, message: e.message };
    } finally {
        document.getElementById('loading-overlay').classList.add('hidden');
    }
}
</script>
</body>
</html>

