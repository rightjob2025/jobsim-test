<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ジョブシミュレーション（プレビュー）</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Chart.js (for radar charts) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif; }
        .chat-container::-webkit-scrollbar { width: 8px; }
        .chat-container::-webkit-scrollbar-track { background: #f1f1f1; }
        .chat-container::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .message { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .choice-button { transition: all 0.2s ease-in-out; }
        .choice-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
        /* ★★★★★ 修正点 ★★★★★ */
        /* topText内のリンクスタイルを追加 */
        #topText a { color: #2563eb; text-decoration: underline; }
        #topText a:hover { color: #1d4ed8; }
        /* ★★★★★ 修正ここまで ★★★★★ */
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <header id="main-header" class="w-full bg-white shadow-md p-3 px-6 flex justify-between items-center sticky top-0 z-20">
        <div class="flex items-center gap-4">
            <img id="main-header-logo" src="" alt="Company Logo" class="h-10 hidden">
            <span id="main-header-company-name" class="text-xl font-bold text-gray-700"></span>
        </div>
    </header>
    
    <div id="app" class="max-w-4xl mx-auto w-full flex-grow flex flex-col p-4">
        <div id="screen-top" class="flex flex-col items-center justify-start pt-20 h-full">
            <img id="topLogo" src="" alt="Company Logo" class="h-16 mb-6 hidden">
            <h1 id="gameTitle" class="text-4xl font-bold text-gray-800 mb-4 text-center"></h1>
            <p class="text-gray-600 mb-8">あなたのキャリアを選択するシミュレーションゲーム</p>
            
            <!-- top_text はボタンの下に移動するため、ここからは削除 -->

            <div class="w-full max-w-sm">
                 <!-- ★★★★★ 修正点 (1) ★★★★★ -->
                 <!-- テキストボックスの上にラベルを追加 -->
                 <label for="userName" class="block text-sm font-medium text-gray-600 mb-1 hidden">あなたのプレイヤー名を入力してください</label>
                 <!-- ★★★★★ 修正ここまで ★★★★★ -->

                 <input type="text" id="userName" placeholder="あなたの名前を入力してください" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4 text-lg">
                 <button id="startButton" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg text-lg disabled:bg-gray-400">シミュレーションを開始</button>

                 <!-- ★★★★★ 修正点 (2) & (3) ★★★★★ -->
                 <!-- top_text をボタンの下に移動し、フォントサイズとマージンを変更 -->
                 <div id="topText" class="text-gray-700 mt-6 text-xs sm:text-sm whitespace-pre-wrap"></div>
                 <!-- ★★★★★ 修正ここまで ★★★★★ -->
            </div>
        </div>

        <div id="screen-game" class="hidden w-full flex flex-col bg-white rounded-2xl shadow-2xl overflow-hidden" style="height: 75vh; max-height: 700px;">
            <header class="bg-gray-800 text-white p-4 flex justify-between items-center shadow-md z-10">
                <div class="flex items-center gap-4">
                    <img id="headerLogo" src="" alt="Company Logo" class="h-8 hidden">
                    <h2 id="phaseTitle" class="text-lg font-bold"></h2>
                </div>
                <div class="flex items-center gap-2">
                    <button id="hintButton" class="hidden bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg text-sm">ガイド</button>
                    <button id="dashboardButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">スコア確認</button>
                </div>
            </header>
            <main id="chat-container" class="chat-container flex-1 p-6 overflow-y-auto space-y-6"></main>
        </div>

        <div id="screen-dashboard" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"> <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md m-4"> <h2 class="text-2xl font-bold mb-4 text-gray-800">現在のスコア</h2> <div style="width: 100%; height: 300px;"> <canvas id="dashboardRadarChart"></canvas> </div> <div class="mt-6 text-center"> <button id="closeDashboardButton" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700 transition duration-300">閉じる</button> </div> </div> </div>
        <div id="screen-hint" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"> <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md m-4"> <h2 class="text-2xl font-bold mb-4 text-gray-800">ガイド</h2> <div id="hintText" class="text-gray-600 mb-6 whitespace-pre-wrap"></div> <div class="mt-6 text-center"> <button id="closeHintButton" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700 transition duration-300">閉じる</button> </div> </div> </div>
        <div id="screen-pre-result" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-end justify-center z-50 pb-20"> <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md m-4 text-center"> <p id="preResultMessage" class="text-2xl font-bold mb-8 text-gray-800"></p> <button id="showResultButton" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg">結果を見る</button> </div> </div>
        <div id="screen-result" class="hidden flex-col items-center justify-center h-full p-4"> <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl text-center"> <h2 id="resultTitle" class="text-3xl font-bold text-gray-800 mb-4"></h2> <div id="resultMessage" class="text-gray-600 mb-6 text-left whitespace-pre-wrap"></div> <div class="my-6"> <canvas id="resultRadarChart"></canvas> </div> <div class="mt-8 flex flex-wrap justify-center gap-4"> <button id="certificateButton" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition duration-300 shadow-lg">修了証を発行する</button> <button id="interviewButton" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg">企業へ応募する</button> <button id="retryButton" class="bg-gray-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-600 transition duration-300 shadow-lg">もう一度挑戦する</button> </div> </div> </div>
    </div>

    <div id="screen-retry-confirm" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md m-4 text-center">
            <p class="text-xl mb-6 text-gray-800">スタート画面へ戻ります。よろしいですか?</p>
            <div class="flex justify-center gap-4">
                 <button id="confirmRetryYes" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">はい</button>
                 <button id="confirmRetryNo" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600">いいえ</button>
            </div>
            <p class="mt-4 text-sm text-gray-500">戻らない場合はブラウザをリロード(F5)してください。</p>
        </div>
    </div>
    
    <footer id="main-footer" class="w-full bg-gray-800 text-white text-center p-4">
        <p>&copy; <span id="copyright-year"></span> <span id="footer-company-name"></span>. All Rights Reserved.</p>
    </footer>

<script>
// ★★★★★【注意】★★★★★
// このファイルはプレビュー専用です。本番では`jobsim_production.html`をご利用ください。
const GAS_URL = 'https://script.google.com/macros/s/AKfycby5J6CR-pgF8imIIlmGagEnSaXLzrzmWpubR9gg_VcwILRvvnUhtJ0BVCTXhk5anvsL/exec';
const SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID_HERE';

// --- Global Variables ---
let gameData = {};
let scores = {};
let userName = '';
let currentPhaseId = 'prologue';
let finalEndContent = null;
let lastDisplayedMessage = '';

// --- DOM Elements ---
const mainHeaderLogo = document.getElementById('main-header-logo');
const mainHeaderCompanyName = document.getElementById('main-header-company-name');
const footerCompanyName = document.getElementById('footer-company-name');
const copyrightYearEl = document.getElementById('copyright-year');
const screens = { top: document.getElementById('screen-top'), game: document.getElementById('screen-game'), dashboard: document.getElementById('screen-dashboard'), hint: document.getElementById('screen-hint'), preResult: document.getElementById('screen-pre-result'), result: document.getElementById('screen-result'), retryConfirm: document.getElementById('screen-retry-confirm') };
const gameTitleEl = document.getElementById('gameTitle');
// ★★★★★ 修正点 ★★★★★
const topTextEl = document.getElementById('topText'); // topText要素を取得
// ★★★★★ 修正ここまで ★★★★★
const userNameInput = document.getElementById('userName');
const startButton = document.getElementById('startButton');
const chatContainer = document.getElementById('chat-container');
const phaseTitleEl = document.getElementById('phaseTitle');
const dashboardButton = document.getElementById('dashboardButton');
const closeDashboardButton = document.getElementById('closeDashboardButton');
const hintButton = document.getElementById('hintButton');
const closeHintButton = document.getElementById('closeHintButton');
const hintTextEl = document.getElementById('hintText');
const preResultMessageEl = document.getElementById('preResultMessage');
const showResultButton = document.getElementById('showResultButton');
const resultTitleEl = document.getElementById('resultTitle');
const resultMessageEl = document.getElementById('resultMessage');
const certificateButton = document.getElementById('certificateButton');
const interviewButton = document.getElementById('interviewButton');
const retryButton = document.getElementById('retryButton');
const confirmRetryYes = document.getElementById('confirmRetryYes');
const confirmRetryNo = document.getElementById('confirmRetryNo');


// ★★★★★【プレビュー機能】★★★★★
window.addEventListener('message', receivePreviewData);
function receivePreviewData(event) {
    if (event.data && event.data.type === 'JOB_SIM_PREVIEW_DATA') {
        console.log('プレビューデータを受信しました:', event.data.payload);
        initializeGame(event.data.payload);
    }
}

// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    setupEventListeners();
    if (window.self === window.top) {
        fetchAndInitialize();
    } else {
        console.log("プレビューモードで待機中...");
    }
});

async function fetchAndInitialize() {
    userNameInput.value = localStorage.getItem('jobsim_userName') || '';
    if(copyrightYearEl) {
        copyrightYearEl.textContent = new Date().getFullYear();
    }
    startButton.disabled = true;
    startButton.textContent = 'データを読み込み中...';
    if (SPREADSHEET_ID === 'YOUR_SPREADSHEET_ID_HERE') {
        alert('エラー: ジョブシムIDが設定されていません。HTMLファイルを編集してください。');
        startButton.textContent = '設定エラー';
        return;
    }
    try {
        const urlWithParams = `${GAS_URL}?spreadsheetId=${SPREADSHEET_ID}&v=${new Date().getTime()}`;
        const data = await fetchJSONP(urlWithParams);
        initializeGame(data);
    } catch (error) {
        console.error('ゲームデータの読み込みに失敗しました:', error);
        alert('ゲームデータの読み込みに失敗しました。\n' + error.message);
        startButton.textContent = '読み込みエラー';
    }
}

function initializeGame(data) {
    if (data.error) {
        alert(`データエラー: ${data.error}`);
        return;
    }
    gameData = data;
    resetGame();
    if (!gameData.contents || gameData.contents.length === 0) {
        alert('コンテンツデータが見つかりません。');
        return;
    }
    gameTitleEl.textContent = gameData.settings.gameTitle || 'ジョブシミュレーション';

    // ★★★★★ 修正点 ★★★★★
    // top_text があれば表示 (innerHTMLを使い、HTMLタグを解釈させる)
    if (gameData.settings.top_text && topTextEl) {
        topTextEl.innerHTML = gameData.settings.top_text;
    } else if (topTextEl) {
        topTextEl.innerHTML = ''; // データがない場合は空にする
    }
    // ★★★★★ 修正ここまで ★★★★★
    
    if (gameData.settings.companyName) {
        mainHeaderCompanyName.textContent = gameData.settings.companyName;
        footerCompanyName.textContent = gameData.settings.companyName;
    }

    if (gameData.settings.companyLogoUrl) {
        const topLogo = document.getElementById('topLogo');
        const headerLogo = document.getElementById('headerLogo');
        const loadImage = (imgElement, type) => {
            if (!imgElement) return;
            imgElement.onerror = () => { console.error(`${type}ロゴの読み込み失敗`); imgElement.classList.add('hidden'); };
            imgElement.onload = () => { imgElement.classList.remove('hidden'); };
            imgElement.src = gameData.settings.companyLogoUrl;
        };
        loadImage(topLogo, 'トップ');
        loadImage(headerLogo, 'ゲームヘッダー');
        loadImage(mainHeaderLogo, 'メインヘッダー');
    }

    scores = {};
    if(gameData.scoreDefinitions) {
        Object.keys(gameData.scoreDefinitions).forEach(key => {
            scores[key] = 0;
        });
    }
    startButton.textContent = 'シミュレーションを開始';
    validateUserName();
}

function setupEventListeners() {
    if (window.listenersAttached) return;
    startButton.addEventListener('click', startGame);
    userNameInput.addEventListener('input', validateUserName);
    dashboardButton.addEventListener('click', showDashboard);
    closeDashboardButton.addEventListener('click', hideDashboard);
    hintButton.addEventListener('click', showHint);
    closeHintButton.addEventListener('click', hideHint);
    showResultButton.addEventListener('click', displayFinalResult);
    certificateButton.addEventListener('click', generateCertificate);
    interviewButton.addEventListener('click', openInterviewLink);
    retryButton.addEventListener('click', showRetryConfirmModal);
    confirmRetryYes.addEventListener('click', handleConfirmRetry);
    confirmRetryNo.addEventListener('click', hideRetryConfirmModal);
    window.listenersAttached = true;
}

function validateUserName() { startButton.disabled = !userNameInput.value.trim() || !gameData.settings; }
function showScreen(screenName) { Object.values(screens).forEach(screen => screen.classList.add('hidden')); screens[screenName].classList.remove('hidden'); if (['top', 'game', 'result'].includes(screenName)) { screens[screenName].classList.add('flex'); } }
function startGame() { userName = userNameInput.value.trim(); localStorage.setItem('jobsim_userName', userName); showScreen('game'); renderPhase(currentPhaseId); }
function resetGame() { currentPhaseId = 'prologue'; scores = {}; chatContainer.innerHTML = ''; showScreen('top'); }
async function renderPhase(phaseId) { const phase = gameData.contents.find(p => p.phaseId?.trim() === phaseId?.trim()); if (!phase) { const endContent = gameData.contents.find(c => c.dataType === 'end' && c.endId === phaseId); if(endContent) { showResult(endContent); } else { alert(`次のコンテンツが見つかりません。(ID: ${phaseId})`); } return; } currentPhaseId = phaseId; phaseTitleEl.textContent = phase.phaseTitle || ''; await displayMessages(phase.phaseDescription); if (phase.taskContent) await displayMedia(phase.taskContent); chatContainer.scrollTop = chatContainer.scrollHeight; const isQuestionPage = phase.taskName?.trim() && phase.choice1_text?.trim(); hintButton.classList.toggle('hidden', !(isQuestionPage && gameData.hints?.[phaseId.trim()])); if (isQuestionPage) { await displayMessage(phase.taskName, 'system'); let choices = []; for (let i = 1; i <= 3; i++) { if (phase[`choice${i}_text`]?.trim()) { choices.push({ text: phase[`choice${i}_text`], score: JSON.parse(phase[`choice${i}_score`] || '{}'), nextPhaseId: phase[`choice${i}_nextPhaseId`], message: phase[`choice${i}_message`] }); } } choices = shuffle(choices); createChoiceButtons(choices); } else { const nextPhaseId = phase.choice1_nextPhaseId; if (nextPhaseId?.trim()) { const delay = Number(gameData.settings.sleepNext) || 1500; await sleep(delay); renderPhase(nextPhaseId.trim()); } else { showResult(calculateEnd()); } } }
async function handleChoice(choice) { document.getElementById('button-wrapper')?.remove(); await displayMessage(choice.text, 'character', userName || 'あなた'); Object.keys(choice.score).forEach(key => { scores[key] = (scores[key] || 0) + Number(choice.score[key] || 0); }); if (choice.message) await displayMessages(choice.message); const delay = Number(gameData.settings.sleepChoice) || 1000; await sleep(delay); const nextPhase = choice.nextPhaseId?.trim(); if (nextPhase?.startsWith('end')) { const endContent = gameData.contents.find(c => c.dataType === 'end' && c.endId === nextPhase); showResult(endContent || calculateEnd()); } else if (nextPhase) { renderPhase(nextPhase); } else { showResult(calculateEnd()); } }
function calculateEnd() { if (!gameData.logics?.length) return gameData.contents.find(c => c.dataType === 'end'); const sortedLogics = [...gameData.logics].sort((a, b) => a.priority - b.priority); for (const logic of sortedLogics) { try { if (!logic.condition) continue; const condition = String(logic.condition).replace(/([a-zA-Z_]\w*)/g, match => `(scores['${match}'] || 0)`); if (eval(condition)) { return gameData.contents.find(c => c.dataType === 'end' && c.endId === logic.endId); } } catch (e) { console.error(`Error in condition for endId ${logic.endId}:`, e); } } return gameData.contents.find(c => c.dataType === 'end'); }
async function displayMessages(description) { if (!description?.trim()) return; const formattedDescription = description.replace(/{{userName}}/g, userName || 'あなた'); if (formattedDescription === lastDisplayedMessage) return; lastDisplayedMessage = formattedDescription; const messages = formattedDescription.split(/<br\s*\/?>/g).filter(m => m.trim()); for (const msg of messages) { const match = msg.trim().match(/^\[(.*?)\](.*)/); await displayMessage(match ? match[2].trim() : msg.trim(), match ? 'character' : 'system', match ? match[1] : ''); const delay = Number(gameData.settings.sleepMessage) || 800; await sleep(delay); } }
function displayMessage(text, type = 'system', speaker = '') { return new Promise(resolve => { const messageWrapper = document.createElement('div'); const iconUrl = gameData.speakers?.[speaker]; if (type === 'character') { const isUser = speaker === (userName || 'あなた'); const iconHtml = iconUrl ? `<img src="${iconUrl}" alt="${speaker}" class="w-10 h-10 rounded-full object-cover">` : `<div class="w-10 h-10 rounded-full flex items-center justify-center font-bold bg-gray-200">${speaker.charAt(0)}</div>`; messageWrapper.className = `message flex items-start gap-3 ${isUser ? 'justify-end' : ''}`; const messageContent = `<div class="flex flex-col ${isUser ? 'items-end' : 'items-start'}"><p class="font-bold">${speaker}</p><div class="mt-1 text-white ${isUser ? 'bg-blue-500' : 'bg-gray-500'} rounded-lg p-3">${text}</div></div>`; messageWrapper.innerHTML = isUser ? messageContent + iconHtml : iconHtml + messageContent; } else { messageWrapper.className = 'message w-full'; messageWrapper.innerHTML = `<div class="text-gray-800 bg-gray-200 border-l-4 border-gray-400 p-3">${text}</div>`; } chatContainer.appendChild(messageWrapper); chatContainer.scrollTop = chatContainer.scrollHeight; setTimeout(resolve, 300); }); }
function convertToEmbedUrl(url) { if (!url || typeof url !== 'string') return ''; const youtubeMatch = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/); if (youtubeMatch) return `https://www.youtube.com/embed/${youtubeMatch[1]}`; const driveMatch = url.match(/drive\.google\.com\/(?:file\/d\/|presentation\/d\/)([a-zA-Z0-9_-]+)/); if (driveMatch) { const fileId = driveMatch[1]; if (url.includes('/presentation/d/')) { return `https://docs.google.com/presentation/d/${fileId}/embed?start=false&loop=false&delayms=3000`; } return `https://drive.google.com/file/d/${fileId}/preview`; } return url; }
function displayMedia(url) { return new Promise(resolve => { if (!url?.trim()) return resolve(); const mediaWrapper = document.createElement('div'); mediaWrapper.className = 'message w-full flex justify-center my-4'; const isImageUrl = /\.(jpeg|jpg|gif|png|webp|svg)$/i.test(url); if (isImageUrl) { mediaWrapper.innerHTML = `<img src="${url}" class="chat-image max-w-full md:max-w-md rounded-lg shadow-md cursor-pointer" alt="コンテンツ画像">`; } else { const embedUrl = convertToEmbedUrl(url); mediaWrapper.innerHTML = `<div class="w-full aspect-video"> <iframe class="w-full h-full rounded-lg shadow-md" src="${embedUrl}" frameborder="0" allowfullscreen></iframe> </div>`; } chatContainer.appendChild(mediaWrapper); chatContainer.scrollTop = chatContainer.scrollHeight; setTimeout(resolve, 300); }); }
function createChoiceButtons(choices) {
    const buttonContainer = document.createElement('div');
    buttonContainer.id = 'button-wrapper';
    buttonContainer.className = 'message grid grid-cols-1 gap-3 py-4';
    choices.forEach(choice => {
        const button = document.createElement('button');
        button.className = 'choice-button w-full bg-white text-blue-600 font-semibold py-3 px-4 border-2 border-blue-500 rounded-lg hover:bg-blue-50';
        button.textContent = choice.text;
        button.onclick = () => handleChoice(choice);
        buttonContainer.appendChild(button);
    });
    chatContainer.appendChild(buttonContainer);
    setTimeout(() => {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }, 100);
}
function showRetryConfirmModal() { screens.retryConfirm.classList.remove('hidden'); }
function hideRetryConfirmModal() { screens.retryConfirm.classList.add('hidden'); }
function handleConfirmRetry() {
    hideRetryConfirmModal();
    resetGame();
}
function showDashboard() { screens.dashboard.classList.remove('hidden'); renderRadarChart('dashboardRadarChart', scores); }
function hideDashboard() { screens.dashboard.classList.add('hidden'); }
function showHint() { const hint = gameData.hints[currentPhaseId.trim()]; if (hint) { hintTextEl.textContent = hint; screens.hint.classList.remove('hidden'); } }
function hideHint() { screens.hint.classList.add('hidden'); }
function showResult(endContent) { finalEndContent = endContent; preResultMessageEl.textContent = `${userName}さん、お疲れ様でした！結果を見てみましょう。`; screens.preResult.classList.remove('hidden'); }
function displayFinalResult() { screens.preResult.classList.add('hidden'); showScreen('result'); resultTitleEl.textContent = finalEndContent.endTitle || 'シミュレーション終了'; resultMessageEl.textContent = (finalEndContent.endMessage || '').replace(/{{userName}}/g, userName || 'あなた'); renderRadarChart('resultRadarChart', scores); }
function openInterviewLink() { if (gameData.settings?.interviewUrl) { window.open(gameData.settings.interviewUrl, '_blank'); } else { alert('URLが設定されていません。'); } }
async function generateCertificate() {
    alert('修了証を生成中です...完了したら自動で保存されます。\n（プレビュー環境ではGoogle Driveへの保存は機能しない場合があります）');
    
    const { jsPDF } = window.jspdf;
    const certificateElement = createCertificateElement();
    document.body.appendChild(certificateElement);

    try {
        // useCORS: true enables cross-origin image loading
        const canvas = await html2canvas(certificateElement, { scale: 3, useCORS: true });
        const imgData = canvas.toDataURL('image/png');
        
        const pdf = new jsPDF({
            orientation: 'landscape',
            unit: 'px',
            format: [canvas.width, canvas.height]
        });
        
        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
        // ファイル名の日付形式を修正
        const pdfFileName = `修了証_${userName}_${new Date().toLocaleDateString('ja-JP').replace(/\//g, '-')}.pdf`;
        pdf.save(pdfFileName);

        // プレビューでもDrive保存を試みる（失敗する可能性あり）
        await saveCertificateToDrive(pdf.output('datauristring'), pdfFileName);

    } catch(err) {
        console.error("PDF Generation Error:", err);
        alert("修了証の生成に失敗しました。ロゴ画像のURLが正しいか、また画像サーバーがCORSリクエストを許可しているか確認してください。");
    } finally {
        if (document.body.contains(certificateElement)) {
            document.body.removeChild(certificateElement);
        }
    }
}

// ★★★★★ ここから追加 ★★★★★
async function saveCertificateToDrive(base64Data, fileName) {
    if (!SPREADSHEET_ID || SPREADSHEET_ID === 'YOUR_SPREADSHEET_ID_HERE') {
        console.warn('PDF保存スキップ: ジョブシムIDが設定されていません。(プレビューモード)');
        // プレビュー中はアラートを出さない
        // alert('PDF保存スキップ: ジョブシムIDが設定されていません。');
        return;
    }
    try {
        const response = await fetch(GAS_URL, { // GAS_URL はプレビュー用URL
            method: 'POST',
            mode: 'cors', // プレビュー環境では 'cors' が失敗する可能性がある
            credentials: 'omit',
            body: JSON.stringify({
                action: 'savePdf',
                spreadsheetId: SPREADSHEET_ID,
                data: base64Data,
                fileName: fileName
            }),
            redirect: 'follow'
        });
        
        if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
        const result = await response.json();
        if (result.status === "success") {
            console.log('修了証が保存されました。');
            alert('修了証が保存されました。');
        } else {
            console.error('保存に失敗しました:', result.message);
            alert(`修了証の保存に失敗しました: ${result.message}`);
        }
    } catch (error) {
        console.error('修了証の送信中にエラーが発生しました:', error);
        // プレビュー環境ではCORSエラーがよく発生するため、アラートを調整
        alert(`修了証の送信中にエラーが発生しました: ${error.message}\n(プレビュー環境ではCORSエラーにより失敗することがあります)`);
    }
}

function createCertificateElement() {
    const now = new Date();
    const dateString = `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日`;
    
    // The logo URL is now directly used in the img tag's src.
    // html2canvas with useCORS:true will handle the fetching.
    const logoUrl = gameData.settings.companyLogoUrl || '';

    const element = document.createElement('div');
    element.style.width = '1056px';
    element.style.height = '816px';
    element.style.position = 'absolute';
    element.style.left = '-9999px';
    element.style.backgroundColor = 'white';
    element.style.padding = '40px';
    element.innerHTML = `
        <div style="border: 10px solid #4a90e2; height: 100%; padding: 40px; display: flex; flex-direction: column; justify-content: space-between; box-sizing: border-box;">
            <div>
                <h1 style="text-align: center; font-size: 48px; color: #333; margin-bottom: 20px;">修了証</h1>
                <p style="text-align: center; font-size: 24px; margin-bottom: 60px;">${userName} 様</p>
                <p style="text-align: center; font-size: 20px; line-height: 1.6;">
                    あなたは「${gameData.settings.certificateCourseName || gameData.settings.gameTitle || '本コース'}」の<br>全課程を修了したことを証します
                </p>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div></div>
                <div style="text-align: right;">
                    <p style="font-size: 18px; margin: 0 0 10px 0;">${dateString}</p>
                    <p style="font-size: 22px; font-weight: bold; margin: 0;">${gameData.settings.companyName || gameData.settings.gameTitle || ''}</p>
                    ${logoUrl ? `<img src="${logoUrl}" crossOrigin="anonymous" alt="Logo" style="max-height: 60px; margin-top: 10px; margin-left: auto;">` : ''}
                </div>
            </div>
        </div>
    `;
    return element;
}
// ★★★★★ 追加ここまで ★★★★★


function fetchJSONP(url) { return new Promise((resolve, reject) => { const cb = 'j' + Math.random().toString(36).substr(2); window[cb] = d => { delete window[cb]; document.body.removeChild(s); resolve(d); }; const s = document.createElement('script'); s.src = `${url}&callback=${cb}`; s.onerror = () => reject(new Error('GAS script fetch failed.')); document.body.appendChild(s); }); }
function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
function shuffle(array) {
    let currentIndex = array.length,  randomIndex;
    while (currentIndex > 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }
    return array;
}
function renderRadarChart(canvasId, data) { const ctx = document.getElementById(canvasId)?.getContext('2d'); if (!ctx) return; const labels = Object.values(gameData.scoreDefinitions || {}); const values = Object.keys(gameData.scoreDefinitions || {}).map(key => data[key] || 0); if (Chart.getChart(canvasId)) Chart.getChart(canvasId).destroy(); new Chart(ctx, { type: 'radar', data: { labels: labels, datasets: [{ label: 'スコア', data: values, fill: true, backgroundColor: 'rgba(54, 162, 235, 0.2)', borderColor: 'rgb(54, 162, 235)' }] }, options: { maintainAspectRatio: false } }); }

</script>
</body>
</html>

