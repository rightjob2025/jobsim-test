<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ジョブシミュレーション</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Chart.js (for radar charts) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Base Styles */
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
        }
        /* Scrollbar Styles */
        .chat-container::-webkit-scrollbar { width: 8px; }
        .chat-container::-webkit-scrollbar-track { background: #f1f1f1; }
        .chat-container::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .chat-container::-webkit-scrollbar-thumb:hover { background: #555; }
        /* Message Animation */
        .message { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Choice Button Styles */
        .choice-button { transition: all 0.2s ease-in-out; }
        .choice-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="max-w-4xl mx-auto h-screen flex flex-col p-4">

        <!-- Top Screen -->
        <div id="screen-top" class="flex flex-col items-center justify-start pt-20 h-full">
            <img id="topLogo" src="" alt="Company Logo" class="h-16 mb-6 hidden">
            <h1 id="gameTitle" class="text-4xl font-bold text-gray-800 mb-4 text-center"></h1>
            <p class="text-gray-600 mb-8">あなたのキャリアを選択するシミュレーションゲーム</p>
            <div class="w-full max-w-sm">
                 <input type="text" id="userName" placeholder="あなたの名前を入力してください" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4 text-lg">
                 <button id="startButton" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg text-lg disabled:bg-gray-400">シミュレーションを開始</button>
            </div>
        </div>

        <!-- Game Screen (Chat UI) -->
        <div id="screen-game" class="hidden h-full w-full flex flex-col bg-white rounded-2xl shadow-2xl overflow-hidden">
            <header class="bg-gray-800 text-white p-4 flex justify-between items-center shadow-md z-10">
                <div class="flex items-center gap-4">
                    <img id="headerLogo" src="" alt="Company Logo" class="h-8 hidden">
                    <h2 id="phaseTitle" class="text-lg font-bold"></h2>
                </div>
                <div class="flex items-center gap-2">
                    <button id="hintButton" class="hidden bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg text-sm">ガイド</button>
                    <button id="dashboardButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">スコア確認</button>
                </div>
            </header>
            
            <main id="chat-container" class="chat-container flex-1 p-6 overflow-y-auto space-y-6">
                <!-- Messages and choices will be dynamically added here -->
            </main>
        </div>

        <!-- Dashboard Screen -->
        <div id="screen-dashboard" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md m-4">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">現在のスコア</h2>
                <div style="width: 100%; height: 300px;">
                    <canvas id="dashboardRadarChart"></canvas>
                </div>
                <div class="mt-6 text-center">
                    <button id="closeDashboardButton" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700 transition duration-300">閉じる</button>
                </div>
            </div>
        </div>
        
        <!-- Guide Display Modal -->
        <div id="screen-hint" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md m-4">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">ガイド</h2>
                <div id="hintText" class="text-gray-600 mb-6 whitespace-pre-wrap"></div>
                <div class="mt-6 text-center">
                    <button id="closeHintButton" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700 transition duration-300">閉じる</button>
                </div>
            </div>
        </div>

        <!-- Pre-Result Modal -->
        <div id="screen-pre-result" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-end justify-center z-50 pb-20">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md m-4 text-center">
                <p id="preResultMessage" class="text-2xl font-bold mb-8 text-gray-800"></p>
                <button id="showResultButton" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg">結果を見る</button>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="screen-result" class="hidden flex-col items-center justify-center h-full p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl text-center">
                <h2 id="resultTitle" class="text-3xl font-bold text-gray-800 mb-4"></h2>
                <div id="resultMessage" class="text-gray-600 mb-6 text-left whitespace-pre-wrap"></div>
                <div class="my-6">
                    <canvas id="resultRadarChart"></canvas>
                </div>
                <div class="mt-8 flex flex-wrap justify-center gap-4">
                    <button id="certificateButton" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition duration-300 shadow-lg">修了証を発行する</button>
                    <button id="interviewButton" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg">企業へ応募する</button>
                    <button id="retryButton" class="bg-gray-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-600 transition duration-300 shadow-lg">もう一度挑戦する</button>
                </div>
            </div>
        </div>
    </div>

<script>
// --- Global Variables ---
const SPREADSHEET_URL = 'https://script.google.com/macros/s/AKfycbxgj4EEtzSq8WcRlBG9uMUzDYN-GI2HtQ8J2yC9b9VZmpMhYLeb1g9kdCbJKDL0mQRY5g/exec';

let gameData = {};
let scores = {};
let userName = '';
let currentPhaseId = 'prologue';
let finalEndContent = null;
let lastDisplayedMessage = '';

// --- DOM Elements ---
const screens = { top: document.getElementById('screen-top'), game: document.getElementById('screen-game'), dashboard: document.getElementById('screen-dashboard'), hint: document.getElementById('screen-hint'), preResult: document.getElementById('screen-pre-result'), result: document.getElementById('screen-result'), };
const gameTitleEl = document.getElementById('gameTitle');
const userNameInput = document.getElementById('userName');
const startButton = document.getElementById('startButton');
const chatContainer = document.getElementById('chat-container');
const phaseTitleEl = document.getElementById('phaseTitle');
const dashboardButton = document.getElementById('dashboardButton');
const closeDashboardButton = document.getElementById('closeDashboardButton');
const hintButton = document.getElementById('hintButton');
const closeHintButton = document.getElementById('closeHintButton');
const hintTextEl = document.getElementById('hintText');
const preResultMessageEl = document.getElementById('preResultMessage');
const showResultButton = document.getElementById('showResultButton');
const resultTitleEl = document.getElementById('resultTitle');
const resultMessageEl = document.getElementById('resultMessage');
const certificateButton = document.getElementById('certificateButton');
const interviewButton = document.getElementById('interviewButton');
const retryButton = document.getElementById('retryButton');


// ★★★★★【プレビュー機能】★★★★★
window.addEventListener('message', receivePreviewData);
function receivePreviewData(event) {
    if (event.data && event.data.type === 'JOB_SIM_PREVIEW_DATA') {
        console.log('プレビューデータを受信しました:', event.data.payload);
        initializeGame(event.data.payload);
    }
}

// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    if (window.self === window.top) {
        fetchAndInitialize();
    } else {
        console.log("プレビューモードで待機中...");
    }
});

async function fetchAndInitialize() {
    setupEventListeners();
    userNameInput.value = localStorage.getItem('jobsim_userName') || '';
    startButton.disabled = true;
    startButton.textContent = 'データを読み込み中...';
    try {
        const cacheBustingUrl = SPREADSHEET_URL + (SPREADSHEET_URL.includes('?') ? '&' : '?') + 'v=' + new Date().getTime();
        const data = await fetchJSONP(cacheBustingUrl);
        initializeGame(data);
    } catch (error) {
        console.error('ゲームデータの読み込みに失敗しました:', error);
        alert('ゲームデータの読み込みに失敗しました。\n' + error.message);
        startButton.textContent = '読み込みエラー';
    }
}

function initializeGame(data) {
    if (data.error) {
        alert(`データエラー: ${data.error}`);
        return;
    }
    gameData = data;
    resetGame();
    if (!gameData.contents || gameData.contents.length === 0) {
        alert('コンテンツデータが見つかりません。');
        return;
    }
    gameTitleEl.textContent = gameData.settings.gameTitle || 'ジョブシミュレーション';
    if (gameData.settings.companyLogoUrl) {
        const topLogo = document.getElementById('topLogo');
        const headerLogo = document.getElementById('headerLogo');
        topLogo.src = gameData.settings.companyLogoUrl;
        headerLogo.src = gameData.settings.companyLogoUrl;
        topLogo.classList.remove('hidden');
        headerLogo.classList.remove('hidden');
    }
    scores = {};
    if(gameData.scoreDefinitions) {
        Object.keys(gameData.scoreDefinitions).forEach(key => {
            scores[key] = 0;
        });
    }
    startButton.textContent = 'シミュレーションを開始';
    validateUserName();
    if (!window.listenersAttached) {
        setupEventListeners();
        window.listenersAttached = true;
    }
}

function setupEventListeners() {
    startButton.addEventListener('click', startGame);
    userNameInput.addEventListener('input', validateUserName);
    dashboardButton.addEventListener('click', showDashboard);
    closeDashboardButton.addEventListener('click', hideDashboard);
    hintButton.addEventListener('click', showHint);
    closeHintButton.addEventListener('click', hideHint);
    showResultButton.addEventListener('click', displayFinalResult);
    certificateButton.addEventListener('click', generateCertificate);
    interviewButton.addEventListener('click', openInterviewLink);
    retryButton.addEventListener('click', () => location.reload());
}

function validateUserName() {
    startButton.disabled = !userNameInput.value.trim() || !gameData.settings;
}

// --- Screen Transitions & Game Logic ---
function showScreen(screenName) {
    Object.values(screens).forEach(screen => screen.classList.add('hidden'));
    screens[screenName].classList.remove('hidden');
    if (['top', 'game', 'result'].includes(screenName)) {
        screens[screenName].classList.add('flex');
    }
}

function startGame() {
    userName = userNameInput.value.trim();
    localStorage.setItem('jobsim_userName', userName);
    showScreen('game');
    renderPhase(currentPhaseId);
}

function resetGame() {
    currentPhaseId = 'prologue';
    scores = {};
    chatContainer.innerHTML = '';
    showScreen('top');
}

async function renderPhase(phaseId) {
    const phase = gameData.contents.find(p => p.phaseId?.trim() === phaseId?.trim());
    if (!phase) {
        const endContent = gameData.contents.find(c => c.dataType === 'end' && c.endId === phaseId);
        if(endContent) { showResult(endContent); } 
        else { alert(`次のコンテンツが見つかりません。(ID: ${phaseId})`); }
        return;
    }
    currentPhaseId = phaseId;
    phaseTitleEl.textContent = phase.phaseTitle || '';
    await displayMessages(phase.phaseDescription);
    
    if (phase.taskContent) await displayMedia(phase.taskContent);

    chatContainer.scrollTop = chatContainer.scrollHeight;
    const isQuestionPage = phase.taskName?.trim() && phase.choice1_text?.trim();
    hintButton.classList.toggle('hidden', !(isQuestionPage && gameData.hints?.[phaseId.trim()]));

    if (isQuestionPage) {
        await displayMessage(phase.taskName, 'system');
        const choices = [];
        for (let i = 1; i <= 3; i++) {
            if (phase[`choice${i}_text`]?.trim()) {
                choices.push({ text: phase[`choice${i}_text`], score: JSON.parse(phase[`choice${i}_score`] || '{}'), nextPhaseId: phase[`choice${i}_nextPhaseId`], message: phase[`choice${i}_message`] });
            }
        }
        createChoiceButtons(choices);
    } else {
        const nextPhaseId = phase.choice1_nextPhaseId;
        if (nextPhaseId?.trim()) {
            await sleep(1500);
            renderPhase(nextPhaseId.trim());
        } else {
             showResult(calculateEnd());
        }
    }
}

async function handleChoice(choice) {
    document.getElementById('button-wrapper')?.remove();
    await displayMessage(choice.text, 'character', userName || 'あなた');
    Object.keys(choice.score).forEach(key => {
        scores[key] = (scores[key] || 0) + Number(choice.score[key] || 0);
    });
    if (choice.message) await displayMessages(choice.message);
    await sleep(1000);
    const nextPhase = choice.nextPhaseId?.trim();
    if (nextPhase?.startsWith('end')) {
        const endContent = gameData.contents.find(c => c.dataType === 'end' && c.endId === nextPhase);
        showResult(endContent || calculateEnd());
    } else if (nextPhase) {
        renderPhase(nextPhase);
    } else {
        showResult(calculateEnd());
    }
}

function calculateEnd() {
    if (!gameData.logics?.length) return gameData.contents.find(c => c.dataType === 'end');
    const sortedLogics = [...gameData.logics].sort((a, b) => a.priority - b.priority);
    for (const logic of sortedLogics) {
        try {
            if (!logic.condition) continue;
            const condition = logic.condition.replace(/([a-zA-Z_]\w*)/g, match => `(scores['${match}'] || 0)`);
            if (eval(condition)) {
                return gameData.contents.find(c => c.dataType === 'end' && c.endId === logic.endId);
            }
        } catch (e) { console.error(`Error in condition for endId ${logic.endId}:`, e); }
    }
    return gameData.contents.find(c => c.dataType === 'end');
}

// --- UI Generation ---
async function displayMessages(description) {
    if (!description?.trim()) return;
    const formattedDescription = description.replace(/{{userName}}/g, userName || 'あなた');
    if (formattedDescription === lastDisplayedMessage) return;
    lastDisplayedMessage = formattedDescription;
    const messages = formattedDescription.split(/<br\s*\/?>/g).filter(m => m.trim());
    for (const msg of messages) {
        const match = msg.trim().match(/^\[(.*?)\](.*)/);
        await displayMessage(match ? match[2].trim() : msg.trim(), match ? 'character' : 'system', match ? match[1] : '');
        await sleep(800);
    }
}

function displayMessage(text, type = 'system', speaker = '') {
    return new Promise(resolve => {
        const messageWrapper = document.createElement('div');
        const iconUrl = gameData.speakers?.[speaker];
        if (type === 'character') {
            const isUser = speaker === (userName || 'あなた');
            const iconHtml = iconUrl ? `<img src="${iconUrl}" alt="${speaker}" class="w-10 h-10 rounded-full object-cover">` : `<div class="w-10 h-10 rounded-full flex items-center justify-center font-bold bg-gray-200">${speaker.charAt(0)}</div>`;
            messageWrapper.className = `message flex items-start gap-3 ${isUser ? 'justify-end' : ''}`;
            const messageContent = `<div class="flex flex-col ${isUser ? 'items-end' : 'items-start'}"><p class="font-bold">${speaker}</p><div class="mt-1 text-white ${isUser ? 'bg-blue-500' : 'bg-gray-500'} rounded-lg p-3">${text}</div></div>`;
            messageWrapper.innerHTML = isUser ? messageContent + iconHtml : iconHtml + messageContent;
        } else {
            messageWrapper.className = 'message w-full';
            messageWrapper.innerHTML = `<div class="text-gray-800 bg-gray-200 border-l-4 border-gray-400 p-3">${text}</div>`;
        }
        chatContainer.appendChild(messageWrapper);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        setTimeout(resolve, 300);
    });
}

// ★★★★★【改善版】★★★★★
function convertToEmbedUrl(url) {
    if (!url || typeof url !== 'string') return '';
    
    // YouTube
    const youtubeMatch = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
    if (youtubeMatch) {
        return `https://www.youtube.com/embed/${youtubeMatch[1]}`;
    }

    // Google Drive (Slides, Docs, Sheets, etc.)
    const driveMatch = url.match(/drive\.google\.com\/(?:file\/d\/|presentation\/d\/|spreadsheets\/d\/|document\/d\/)([a-zA-Z0-9_-]+)/);
    if (driveMatch) {
        const fileId = driveMatch[1];
        // プレゼンテーション（スライド）用の埋め込みURLを生成
        if (url.includes('/presentation/d/')) {
             return `https://docs.google.com/presentation/d/${fileId}/embed?start=false&loop=false&delayms=3000`;
        }
        // その他のファイル（動画、PDFなど）はpreview形式で埋め込む
        return `https://drive.google.com/file/d/${fileId}/preview`;
    }

    // If it's some other URL, return it as is
    return url;
}


function displayMedia(url) {
    return new Promise(resolve => {
        if (!url?.trim()) return resolve();
        const mediaWrapper = document.createElement('div');
        mediaWrapper.className = 'message w-full flex justify-center my-4';
        const isImageUrl = /\.(jpeg|jpg|gif|png|webp|svg)$/i.test(url);

        if (isImageUrl) {
            mediaWrapper.innerHTML = `<img src="${url}" class="chat-image max-w-full md:max-w-md rounded-lg shadow-md cursor-pointer" alt="コンテンツ画像">`;
        } else {
            const embedUrl = convertToEmbedUrl(url);
            mediaWrapper.innerHTML = `<div class="w-full aspect-video">
                                        <iframe class="w-full h-full rounded-lg shadow-md" src="${embedUrl}" frameborder="0" allowfullscreen></iframe>
                                      </div>`;
        }
        chatContainer.appendChild(mediaWrapper);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        setTimeout(resolve, 300);
    });
}


function createChoiceButtons(choices) {
    const buttonContainer = document.createElement('div');
    buttonContainer.id = 'button-wrapper';
    buttonContainer.className = 'message grid grid-cols-1 gap-3 py-4';
    choices.forEach(choice => {
        const button = document.createElement('button');
        button.className = 'choice-button w-full bg-white text-blue-600 font-semibold py-3 px-4 border-2 border-blue-500 rounded-lg hover:bg-blue-50';
        button.textContent = choice.text;
        button.onclick = () => handleChoice(choice);
        buttonContainer.appendChild(button);
    });
    chatContainer.appendChild(buttonContainer);
}

// --- Modals & Results ---
function showDashboard() { screens.dashboard.classList.remove('hidden'); renderRadarChart('dashboardRadarChart', scores); }
function hideDashboard() { screens.dashboard.classList.add('hidden'); }
function showHint() { const hint = gameData.hints[currentPhaseId.trim()]; if (hint) { hintTextEl.textContent = hint; screens.hint.classList.remove('hidden'); } }
function hideHint() { screens.hint.classList.add('hidden'); }
function showResult(endContent) { finalEndContent = endContent; preResultMessageEl.textContent = `${userName}さん、お疲れ様でした！結果を見てみましょう。`; screens.preResult.classList.remove('hidden'); }
function displayFinalResult() { screens.preResult.classList.add('hidden'); showScreen('result'); resultTitleEl.textContent = finalEndContent.endTitle || 'シミュレーション終了'; resultMessageEl.textContent = (finalEndContent.endMessage || '').replace(/{{userName}}/g, userName || 'あなた'); renderRadarChart('resultRadarChart', scores); }
function openInterviewLink() { if (gameData.settings?.interviewUrl) { window.open(gameData.settings.interviewUrl, '_blank'); } else { alert('URLが設定されていません。'); } }
async function generateCertificate() { alert('修了証を生成中です...'); /* ... 実装 ... */ }

// --- Utilities ---
function fetchJSONP(url) { return new Promise((resolve, reject) => { const cb = 'j' + Math.random().toString(36).substr(2); window[cb] = d => { delete window[cb]; document.body.removeChild(s); resolve(d); }; const s = document.createElement('script'); s.src = `${url}${url.includes('?') ? '&' : '?'}callback=${cb}`; s.onerror = () => reject(new Error('GAS script fetch failed.')); document.body.appendChild(s); }); }
function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
function renderRadarChart(canvasId, data) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    const labels = Object.values(gameData.scoreDefinitions || {});
    const values = Object.keys(gameData.scoreDefinitions || {}).map(key => data[key] || 0);
    if (Chart.getChart(canvasId)) Chart.getChart(canvasId).destroy();
    new Chart(ctx, { type: 'radar', data: { labels: labels, datasets: [{ label: 'スコア', data: values, fill: true, backgroundColor: 'rgba(54, 162, 235, 0.2)', borderColor: 'rgb(54, 162, 235)' }] }, options: { maintainAspectRatio: false } });
}

</script>
</body>
</html>

