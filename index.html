<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ジョブシミュレーション</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Chart.js (for radar charts) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Base Styles */
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
        }
        /* Scrollbar Styles */
        .chat-container::-webkit-scrollbar { width: 8px; }
        .chat-container::-webkit-scrollbar-track { background: #f1f1f1; }
        .chat-container::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .chat-container::-webkit-scrollbar-thumb:hover { background: #555; }
        /* Message Animation */
        .message { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Choice Button Styles */
        .choice-button { transition: all 0.2s ease-in-out; }
        .choice-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="max-w-4xl mx-auto h-screen flex flex-col p-4">

        <!-- Top Screen -->
        <div id="screen-top" class="flex flex-col items-center justify-start pt-20 h-full">
            <img id="topLogo" src="" alt="Company Logo" class="h-16 mb-6 hidden">
            <h1 id="gameTitle" class="text-4xl font-bold text-gray-800 mb-4 text-center"></h1>
            <p class="text-gray-600 mb-8">あなたのキャリアを選択するシミュレーションゲーム</p>
            <div class="w-full max-w-sm">
                 <input type="text" id="userName" placeholder="あなたの名前を入力してください" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4 text-lg">
                 <button id="startButton" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg text-lg disabled:bg-gray-400">シミュレーションを開始</button>
            </div>
        </div>

        <!-- Game Screen (Chat UI) -->
        <div id="screen-game" class="hidden h-full w-full flex flex-col bg-white rounded-2xl shadow-2xl overflow-hidden">
            <header class="bg-gray-800 text-white p-4 flex justify-between items-center shadow-md z-10">
                <div class="flex items-center gap-4">
                    <img id="headerLogo" src="" alt="Company Logo" class="h-8 hidden">
                    <h2 id="phaseTitle" class="text-lg font-bold"></h2>
                </div>
                <div class="flex items-center gap-2">
                    <button id="hintButton" class="hidden bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg text-sm">ガイド</button>
                    <button id="dashboardButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">スコア確認</button>
                </div>
            </header>
            
            <main id="chat-container" class="chat-container flex-1 p-6 overflow-y-auto space-y-6">
                <!-- Messages and choices will be dynamically added here -->
            </main>
        </div>

        <!-- (Dashboard, Hint, Result Modals are omitted for brevity) -->
        <div id="screen-dashboard" class="hidden"></div>
        <div id="screen-hint" class="hidden"></div>
        <div id="screen-pre-result" class="hidden"></div>
        <div id="screen-result" class="hidden"></div>
    </div>

<script>
// --- Global Variables ---
const SPREADSHEET_URL = 'https://script.google.com/macros/s/AKfycbxgj4EEtzSq8WcRlBG9uMUzDYN-GI2HtQ8J2yC9b9VZmpMhYLeb1g9kdCbJKDL0mQRY5g/exec';

let gameData = {};
let scores = {};
let userName = '';
let currentPhaseId = 'prologue';
let finalEndContent = null;
let lastDisplayedMessage = '';

// --- DOM Elements ---
const screens = { top: document.getElementById('screen-top'), game: document.getElementById('screen-game'), dashboard: document.getElementById('screen-dashboard'), hint: document.getElementById('screen-hint'), preResult: document.getElementById('screen-pre-result'), result: document.getElementById('screen-result'), };
const gameTitleEl = document.getElementById('gameTitle');
const userNameInput = document.getElementById('userName');
const startButton = document.getElementById('startButton');
const chatContainer = document.getElementById('chat-container');
const phaseTitleEl = document.getElementById('phaseTitle');
const dashboardButton = document.getElementById('dashboardButton');
const hintButton = document.getElementById('hintButton');
// (Other DOM element declarations are omitted for brevity)


// ★★★★★【プレビュー機能】★★★★★
window.addEventListener('message', receivePreviewData);
function receivePreviewData(event) {
    if (event.data && event.data.type === 'JOB_SIM_PREVIEW_DATA') {
        console.log('プレビューデータを受信しました:', event.data.payload);
        initializeGame(event.data.payload);
    }
}

// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    if (window.self === window.top) {
        fetchAndInitialize();
    } else {
        console.log("プレビューモードで待機中...");
    }
});

async function fetchAndInitialize() {
    setupEventListeners();
    userNameInput.value = localStorage.getItem('jobsim_userName') || '';
    startButton.disabled = true;
    startButton.textContent = 'データを読み込み中...';
    try {
        const cacheBustingUrl = SPREADSHEET_URL + (SPREADSHEET_URL.includes('?') ? '&' : '?') + 'v=' + new Date().getTime();
        const data = await fetchJSONP(cacheBustingUrl);
        initializeGame(data);
    } catch (error) {
        console.error('ゲームデータの読み込みに失敗しました:', error);
        alert('ゲームデータの読み込みに失敗しました。\n' + error.message);
        startButton.textContent = '読み込みエラー';
    }
}

function initializeGame(data) {
    if (data.error) {
        alert(`データエラー: ${data.error}`);
        return;
    }
    gameData = data;
    resetGame();
    if (!gameData.contents || gameData.contents.length === 0) {
        alert('コンテンツデータが見つかりません。');
        return;
    }
    gameTitleEl.textContent = gameData.settings.gameTitle || 'ジョブシミュレーション';
    if (gameData.settings.companyLogoUrl) {
        document.getElementById('topLogo').src = gameData.settings.companyLogoUrl;
        document.getElementById('headerLogo').src = gameData.settings.companyLogoUrl;
        document.getElementById('topLogo').classList.remove('hidden');
        document.getElementById('headerLogo').classList.remove('hidden');
    }
    scores = {};
    if(gameData.scoreDefinitions) {
        Object.keys(gameData.scoreDefinitions).forEach(key => {
            scores[key] = 0;
        });
    }
    startButton.textContent = 'シミュレーションを開始';
    validateUserName();
    if (!window.listenersAttached) {
        setupEventListeners();
        window.listenersAttached = true;
    }
}

function setupEventListeners() {
    startButton.addEventListener('click', startGame);
    userNameInput.addEventListener('input', validateUserName);
    dashboardButton.addEventListener('click', showDashboard);
    // (Other event listeners are omitted for brevity)
}

function validateUserName() {
    startButton.disabled = !userNameInput.value.trim() || !gameData.settings;
}

// --- Screen Transitions & Game Logic ---
function showScreen(screenName) {
    Object.values(screens).forEach(screen => screen.classList.add('hidden'));
    screens[screenName].classList.remove('hidden');
    if (['top', 'game', 'result'].includes(screenName)) {
        screens[screenName].classList.add('flex');
    }
}

function startGame() {
    userName = userNameInput.value.trim();
    localStorage.setItem('jobsim_userName', userName);
    showScreen('game');
    renderPhase(currentPhaseId);
}

function resetGame() {
    currentPhaseId = 'prologue';
    scores = {};
    chatContainer.innerHTML = '';
    showScreen('top');
}

async function renderPhase(phaseId) {
    const phase = gameData.contents.find(p => p.phaseId?.trim() === phaseId?.trim());
    if (!phase) {
        // (End of simulation logic is omitted for brevity)
        return;
    }
    currentPhaseId = phaseId;
    phaseTitleEl.textContent = phase.phaseTitle || '';
    await displayMessages(phase.phaseDescription);
    
    if (phase.taskContent) await displayMedia(phase.taskContent);

    chatContainer.scrollTop = chatContainer.scrollHeight;
    const isQuestionPage = phase.taskName?.trim() && phase.choice1_text?.trim();
    hintButton.classList.toggle('hidden', !(isQuestionPage && gameData.hints?.[phaseId.trim()]));

    if (isQuestionPage) {
        await displayMessage(phase.taskName, 'system');
        const choices = [];
        for (let i = 1; i <= 3; i++) {
            if (phase[`choice${i}_text`]?.trim()) {
                choices.push({ text: phase[`choice${i}_text`], score: JSON.parse(phase[`choice${i}_score`] || '{}'), nextPhaseId: phase[`choice${i}_nextPhaseId`], message: phase[`choice${i}_message`] });
            }
        }
        createChoiceButtons(choices);
    } else {
        const nextPhaseId = phase.choice1_nextPhaseId;
        if (nextPhaseId?.trim()) {
            // ★★★★★【速度調整】★★★★★
            const delay = Number(gameData.settings.sleepNext) || 1500;
            await sleep(delay);
            renderPhase(nextPhaseId.trim());
        } else {
             showResult(calculateEnd());
        }
    }
}

async function handleChoice(choice) {
    document.getElementById('button-wrapper')?.remove();
    await displayMessage(choice.text, 'character', userName || 'あなた');
    Object.keys(choice.score).forEach(key => {
        scores[key] = (scores[key] || 0) + Number(choice.score[key] || 0);
    });
    if (choice.message) await displayMessages(choice.message);
    
    // ★★★★★【速度調整】★★★★★
    const delay = Number(gameData.settings.sleepChoice) || 1000;
    await sleep(delay);

    const nextPhase = choice.nextPhaseId?.trim();
    if (nextPhase?.startsWith('end')) {
        const endContent = gameData.contents.find(c => c.dataType === 'end' && c.endId === nextPhase);
        showResult(endContent || calculateEnd());
    } else if (nextPhase) {
        renderPhase(nextPhase);
    } else {
        showResult(calculateEnd());
    }
}

function calculateEnd() {
    // (Calculation logic is omitted for brevity)
    return gameData.contents.find(c => c.dataType === 'end');
}

// --- UI Generation ---
async function displayMessages(description) {
    if (!description?.trim()) return;
    const formattedDescription = description.replace(/{{userName}}/g, userName || 'あなた');
    if (formattedDescription === lastDisplayedMessage) return;
    lastDisplayedMessage = formattedDescription;
    const messages = formattedDescription.split(/<br\s*\/?>/g).filter(m => m.trim());
    for (const msg of messages) {
        const match = msg.trim().match(/^\[(.*?)\](.*)/);
        await displayMessage(match ? match[2].trim() : msg.trim(), match ? 'character' : 'system', match ? match[1] : '');
        
        // ★★★★★【速度調整】★★★★★
        const delay = Number(gameData.settings.sleepMessage) || 800;
        await sleep(delay);
    }
}

function displayMessage(text, type = 'system', speaker = '') {
    // (Message display logic is omitted for brevity)
    return new Promise(resolve => setTimeout(resolve, 300));
}

function convertToEmbedUrl(url) {
    // (URL conversion logic is omitted for brevity)
    return url;
}


function displayMedia(url) {
    // (Media display logic is omitted for brevity)
    return new Promise(resolve => setTimeout(resolve, 300));
}


function createChoiceButtons(choices) {
    // (Button creation logic is omitted for brevity)
}

// --- Modals & Results ---
function showDashboard() { /* Omitted */ }
// (Other modal functions are omitted for brevity)

// --- Utilities ---
function fetchJSONP(url) { return new Promise((resolve, reject) => { const cb = 'j' + Math.random().toString(36).substr(2); window[cb] = d => { delete window[cb]; document.body.removeChild(s); resolve(d); }; const s = document.createElement('script'); s.src = `${url}${url.includes('?') ? '&' : '?'}callback=${cb}`; s.onerror = () => reject(new Error('GAS script fetch failed.')); document.body.appendChild(s); }); }
function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
function renderRadarChart(canvasId, data) { /* Omitted */ }

</script>
</body>
</html>

